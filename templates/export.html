{% extends "base.html" %}
{% set active_page = "export" %}

{% block title %}Export Data{% endblock %}

{% block content %}
<div class="page-header">
    <h2>üì¶ Export Data</h2>
    <p>Download your scraped business data as CSV</p>
</div>

<!-- Existing Export Files -->
<div class="card">
    <div class="card-header">
        <span class="card-title">üìÅ Available Files</span>
    </div>
    {% if export_files %}
    <table>
        <thead>
            <tr>
                <th>Filename</th>
                <th>Size</th>
                <th>Date</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for f in export_files %}
            <tr>
                <td>üìÑ {{ f.name }}</td>
                <td>{{ f.size }}</td>
                <td>{{ f.date }}</td>
                <td><a href="/download/{{ f.name }}" class="btn btn-accent btn-sm">‚¨á Download</a></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color: var(--text-muted); text-align: center; padding: 30px;">
        No export files yet. Run the scraper first or create an export below.
    </p>
    {% endif %}
</div>

<!-- Create New Export -->
<div class="card">
    <div class="card-header">
        <span class="card-title">üîß Create New Export from Database</span>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 20px;">
        <div class="form-group">
            <label>Website Filter</label>
            <select class="form-select" id="websiteFilter">
                <option value="">All businesses</option>
                <option value="true">Only WITH website</option>
                <option value="false">Only WITHOUT website</option>
            </select>
        </div>

        <div class="form-group">
            <label>
                <input type="checkbox" id="filterCities"
                    onchange="document.getElementById('citiesGroup').style.display = this.checked ? 'block' : 'none';">
                Filter by Cities
            </label>
            <div id="citiesGroup"
                style="display: none; max-height: 150px; overflow-y: auto; margin-top: 8px; padding: 8px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-input);">
                {% for city in cities %}
                <label style="display: block; padding: 4px 0; font-size: 13px; cursor: pointer;">
                    <input type="checkbox" name="city" value="{{ city }}"> {{ city }}
                </label>
                {% endfor %}
            </div>
        </div>

        <div class="form-group">
            <label>
                <input type="checkbox" id="filterCategories"
                    onchange="document.getElementById('categoriesGroup').style.display = this.checked ? 'block' : 'none';">
                Filter by Categories
            </label>
            <div id="categoriesGroup"
                style="display: none; max-height: 150px; overflow-y: auto; margin-top: 8px; padding: 8px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--bg-input);">
                {% for category in categories %}
                <label style="display: block; padding: 4px 0; font-size: 13px; cursor: pointer;">
                    <input type="checkbox" name="category" value="{{ category }}"> {{ category }}
                </label>
                {% endfor %}
            </div>
        </div>
    </div>

    <button class="btn btn-success" onclick="exportData()">üì• Export to CSV</button>
</div>
{% endblock %}

{% block scripts %}
<script>
    function exportData() {
        const websiteFilter = document.getElementById('websiteFilter').value;

        const cities = [];
        if (document.getElementById('filterCities').checked) {
            document.querySelectorAll('input[name="city"]:checked').forEach(cb => cities.push(cb.value));
        }

        const categories = [];
        if (document.getElementById('filterCategories').checked) {
            document.querySelectorAll('input[name="category"]:checked').forEach(cb => categories.push(cb.value));
        }

        const data = {
            cities: cities.length > 0 ? cities : null,
            categories: categories.length > 0 ? categories : null,
            has_website: websiteFilter ? (websiteFilter === 'true') : null
        };

        fetch('/api/export', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(r => {
                if (!r.ok) throw new Error('No data matches filters');
                return r.json();
            })
            .then(result => {
                if (result.success) {
                    showToast(`Exported ${result.count} records!`, 'success');
                    window.location.href = result.download_url;
                    setTimeout(() => location.reload(), 2000);
                }
            })
            .catch(err => {
                showToast(err.message || 'Export failed', 'error');
            });
    }
</script>
{% endblock %}