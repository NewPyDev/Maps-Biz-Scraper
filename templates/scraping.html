{% extends "base.html" %}
{% set active_page = "scraping" %}

{% block title %}Scraping{% endblock %}

{% block content %}
<div class="page-header">
    <h2>ğŸ”„ Scraping Management</h2>
    <p>Control the scraper, manage jobs, and edit source files</p>
</div>

<!-- Scraper Controls -->
<div class="card">
    <div class="card-header">
        <span class="card-title">âš™ï¸ Scraper Control</span>
        <span style="font-size: 12px; color: var(--text-muted);" id="lastUpdate">Live updates active</span>
    </div>

    <div id="scraperStatusBox"
        style="padding: 16px; border-radius: var(--radius-sm); margin-bottom: 16px; background: var(--bg-input); border: 1px solid var(--border);">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
            <span class="status-dot" id="statusDot"></span>
            <strong id="statusLabel" style="font-size: 16px;">Checking...</strong>
        </div>
        <div id="currentJobInfo"
            style="display: none; font-size: 13px; color: var(--text-secondary); margin-left: 20px;">
            <p>ğŸ“‚ <span id="jobCategory"></span> in <span id="jobCity"></span></p>
            <p>ğŸ¢ Last: <span id="currentBusiness">-</span></p>
            <p>ğŸ“Š Scraped: <span id="businessCount">0</span></p>
        </div>
    </div>

    <div class="btn-group">
        <button class="btn btn-success" onclick="startScraper()" id="btnStart">â–¶ Start</button>
        <button class="btn btn-warning" onclick="pauseScraper()" id="btnPause" disabled>â¸ Pause</button>
        <button class="btn btn-accent" onclick="resumeScraper()" id="btnResume" disabled>â–¶ Resume</button>
        <button class="btn btn-danger" onclick="stopScraper()" id="btnStop" disabled>â¹ Stop</button>
        <button class="btn btn-ghost" onclick="skipCurrent()" id="btnSkip" disabled>â­ Skip</button>
        <button class="btn btn-danger btn-sm" onclick="forceUnstuck()" style="margin-left: auto;">ğŸ”§ Reset</button>
    </div>
</div>

<!-- Scraper Configuration -->
<div class="card">
    <div class="card-header">
        <span class="card-title">âš™ï¸ Configuration</span>
    </div>
    <div style="display: flex; align-items: center; gap: 16px;">
        <div class="form-group" style="margin-bottom: 0; flex: 1;">
            <label>Max Results per Job</label>
            <div style="display: flex; gap: 8px;">
                <input type="number" class="form-input" id="maxResults" placeholder="50" min="1" max="10000">
                <button class="btn btn-accent" onclick="saveSettings()">ğŸ’¾ Update</button>
            </div>
            <p style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">Higher values = more results but
                takes longer. Default: 50.</p>
        </div>
    </div>
</div>

<!-- Job Statistics -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">Pending</div>
        <div class="stat-value" id="statPending" style="color: var(--warning);">{{ job_counts.get('pending', 0) }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Running</div>
        <div class="stat-value" id="statRunning" style="color: var(--info);">{{ job_counts.get('running', 0) }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Completed</div>
        <div class="stat-value" id="statCompleted" style="color: var(--success);">{{ job_counts.get('completed', 0) }}
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Failed</div>
        <div class="stat-value" id="statFailed" style="color: var(--danger);">{{ job_counts.get('failed', 0) }}</div>
    </div>
</div>

<!-- File Editors (jobs.csv & places.csv) -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
    <div class="card">
        <div class="card-header">
            <span class="card-title">ğŸ“ jobs.csv <span
                    style="font-size: 11px; color: var(--text-muted);">(categories)</span></span>
            <button class="btn btn-accent btn-sm" onclick="saveFile('jobs.csv')">ğŸ’¾ Save</button>
        </div>
        <textarea class="form-textarea" id="jobsContent"
            placeholder="One category per line...">{{ jobs_content }}</textarea>
    </div>
    <div class="card">
        <div class="card-header">
            <span class="card-title">ğŸ“ places.csv <span
                    style="font-size: 11px; color: var(--text-muted);">(city,country)</span></span>
            <button class="btn btn-accent btn-sm" onclick="saveFile('places.csv')">ğŸ’¾ Save</button>
        </div>
        <textarea class="form-textarea" id="placesContent"
            placeholder="City,Country per line...">{{ places_content }}</textarea>
    </div>
</div>

<!-- Bulk Import + Add Single Job -->
<div class="card">
    <div class="card-header">
        <span class="card-title">â• Add Jobs to Queue</span>
    </div>

    <div style="display: flex; gap: 16px; flex-wrap: wrap; align-items: end;">
        <!-- Bulk import from CSV files -->
        <div>
            <button class="btn btn-accent" onclick="bulkImport()">ğŸ“¥ Import from CSV Files</button>
            <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">Creates all category Ã— city combos
            </div>
        </div>

        <div style="border-left: 1px solid var(--border); height: 40px;"></div>

        <!-- Add single job -->
        <div class="form-group" style="margin-bottom: 0;">
            <label>Category</label>
            <input type="text" class="form-input" id="addCategory" placeholder="e.g. Plumber" style="width: 180px;">
        </div>
        <div class="form-group" style="margin-bottom: 0;">
            <label>City</label>
            <input type="text" class="form-input" id="addCity" placeholder="e.g. Paris" style="width: 150px;">
        </div>
        <div class="form-group" style="margin-bottom: 0;">
            <label>Country</label>
            <input type="text" class="form-input" id="addCountry" placeholder="e.g. France" style="width: 150px;">
        </div>
        <button class="btn btn-success" onclick="addSingleJob()">+ Add</button>
    </div>
</div>

<!-- Proxies Editor -->
<div class="card">
    <div class="card-header">
        <span class="card-title">ğŸŒ proxies.txt</span>
        <div style="display: flex; gap: 8px;">
            <button class="btn btn-warning btn-sm" onclick="fetchProxies()">ğŸ”„ Fetch Free</button>
            <button class="btn btn-accent btn-sm" onclick="saveFile('proxies.txt')">ğŸ’¾ Save</button>
        </div>
    </div>
    <textarea class="form-textarea" id="proxiesContent" style="min-height: 80px;"
        placeholder="One proxy per line (host:port or host:port:user:pass)..."></textarea>
</div>

<!-- Pending Jobs Table -->
<div class="card">
    <div class="card-header">
        <span class="card-title">â³ Pending Jobs ({{ pending_jobs|length }})</span>
        <div class="btn-group">
            <button class="btn btn-ghost btn-sm" onclick="selectAll()">Select All</button>
            <button class="btn btn-ghost btn-sm" onclick="deselectAll()">Deselect</button>
            <button class="btn btn-danger btn-sm" onclick="deleteSelected()">ğŸ—‘ Delete Selected</button>
        </div>
    </div>
    {% if pending_jobs %}
    <div style="max-height: 400px; overflow-y: auto;">
        <table>
            <thead>
                <tr>
                    <th style="width: 40px;"><input type="checkbox" id="selectAllCb" onchange="toggleAll(this)"></th>
                    <th>Category</th>
                    <th>City</th>
                    <th>Country</th>
                    <th style="width: 80px;">Action</th>
                </tr>
            </thead>
            <tbody id="pendingTableBody">
                {% for job in pending_jobs %}
                <tr data-job-id="{{ job.id }}">
                    <td><input type="checkbox" class="job-cb" value="{{ job.id }}"></td>
                    <td>{{ job.category }}</td>
                    <td>{{ job.city }}</td>
                    <td>{{ job.country }}</td>
                    <td><button class="btn btn-danger btn-sm" onclick="deleteJob('{{ job.id }}')">&times;</button></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p style="color: var(--text-muted); text-align: center; padding: 30px;">
        No pending jobs. Import from CSV or add manually above.
    </p>
    {% endif %}
</div>

<!-- Recent Completed/Failed -->
{% if other_jobs %}
<div class="card">
    <div class="card-header">
        <span class="card-title">ğŸ“‹ Recent Jobs</span>
        <button class="btn btn-ghost btn-sm" onclick="clearCompleted()">Clear History</button>
    </div>
    <table>
        <thead>
            <tr>
                <th>Category</th>
                <th>City</th>
                <th>Status</th>
                <th>Leads</th>
                <th>Error</th>
            </tr>
        </thead>
        <tbody>
            {% for job in other_jobs %}
            <tr>
                <td>{{ job.category }}</td>
                <td>{{ job.city }}, {{ job.country }}</td>
                <td>
                    {% if job.status == 'completed' %}
                    <span class="badge badge-success">Completed</span>
                    {% elif job.status == 'running' %}
                    <span class="badge badge-info">Running</span>
                    {% elif job.status == 'failed' %}
                    <span class="badge badge-danger">Failed</span>
                    {% endif %}
                </td>
                <td>{{ job.businesses_found or 0 }}</td>
                <td
                    style="color: var(--text-muted); max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    {{ job.error_message or '-' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    // Load proxies content
    fetch('/api/files/proxies.txt')
        .then(r => r.json())
        .then(data => { document.getElementById('proxiesContent').value = data.content; });

    // Load settings
    fetch('/api/settings')
        .then(r => r.json())
        .then(data => {
            if (data.max_results) document.getElementById('maxResults').value = data.max_results;
        });

    function saveSettings() {
        const val = parseInt(document.getElementById('maxResults').value);
        if (!val || val < 1) { showToast('Invalid value', 'error'); return; }

        fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ max_results: val })
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) showToast(data.message, 'success');
                else showToast(data.error, 'error');
            });
    }

    // â”€â”€ Scraper Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function startScraper() {
        fetch('/api/start', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.success) { showToast(data.message || 'Scraper started!', 'success'); updateStatus(); }
                else showToast(data.error, 'error');
            });
    }

    function pauseScraper() {
        fetch('/api/pause', { method: 'POST' }).then(r => r.json())
            .then(data => { if (data.success) { showToast('Paused', 'info'); updateStatus(); } });
    }

    function resumeScraper() {
        fetch('/api/resume', { method: 'POST' }).then(r => r.json())
            .then(data => { if (data.success) { showToast('Resumed', 'success'); updateStatus(); } });
    }

    function stopScraper() {
        fetch('/api/stop', { method: 'POST' }).then(r => r.json())
            .then(data => { if (data.success) { showToast('Stopping...', 'info'); updateStatus(); } });
    }

    function skipCurrent() {
        fetch('/api/skip', { method: 'POST' }).then(r => r.json())
            .then(data => { if (data.success) { showToast('Skipping current job', 'info'); updateStatus(); } });
    }

    function forceUnstuck() {
        if (!confirm('Reset stuck jobs to pending?')) return;
        fetch('/api/unstuck', { method: 'POST' }).then(r => r.json())
            .then(data => {
                if (data.success) {
                    showToast(`Reset complete! ${data.jobs_reset} jobs reset.`, 'success');
                    updateStatus();
                    setTimeout(() => location.reload(), 1500);
                }
            });
    }

    // â”€â”€ Live Status Updates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function updateStatus() {
        fetch('/api/status')
            .then(r => r.json())
            .then(data => {
                const dot = document.getElementById('statusDot');
                const label = document.getElementById('statusLabel');
                dot.className = 'status-dot ' + data.status;

                const labels = { running: 'ğŸŸ¢ Running', paused: 'â¸ï¸ Paused', stopped: 'âšª Idle', error: 'âŒ Error' };
                label.textContent = labels[data.status] || data.status;

                // Button states
                const isRunning = data.status === 'running';
                const isPaused = data.status === 'paused';
                const isStopped = data.status === 'stopped' || data.status === 'error';

                document.getElementById('btnStart').disabled = !isStopped;
                document.getElementById('btnPause').disabled = !isRunning;
                document.getElementById('btnResume').disabled = !isPaused;
                document.getElementById('btnStop').disabled = isStopped;
                document.getElementById('btnSkip').disabled = !isRunning;

                // Current job info
                const jobInfo = document.getElementById('currentJobInfo');
                if (data.current_job) {
                    jobInfo.style.display = 'block';
                    document.getElementById('jobCategory').textContent = data.current_job.category;
                    document.getElementById('jobCity').textContent = data.current_job.city + ', ' + data.current_job.country;
                    document.getElementById('currentBusiness').textContent = data.stats.current_business || '-';
                    document.getElementById('businessCount').textContent = data.stats.businesses_scraped || 0;
                } else {
                    jobInfo.style.display = 'none';
                }

                // Update time
                document.getElementById('lastUpdate').textContent = 'Updated: ' + new Date().toLocaleTimeString();
            });
    }

    setInterval(updateStatus, 4000);
    updateStatus();

    // â”€â”€ File Save â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function fetchProxies() {
        if (!confirm('This will fetch AND VERIFY free proxies. It will OVERWRITE your current list. Continue?')) return;
        showToast('Fetching & Verifying proxies (this takes 30-60s)...', 'info');

        document.getElementById('proxiesContent').disabled = true;

        fetch('/api/proxies/fetch', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                document.getElementById('proxiesContent').disabled = false;
                if (data.success) {
                    showToast(data.message, 'success');
                    // Reload textarea
                    fetch('/api/files/proxies.txt')
                        .then(r => r.json())
                        .then(fileData => {
                            document.getElementById('proxiesContent').value = fileData.content;
                        });
                } else {
                    showToast(data.error, 'error');
                }
            })
            .catch(e => {
                document.getElementById('proxiesContent').disabled = false;
                showToast('Network error', 'error');
            });
    }

    function saveFile(filename) {
        let contentId;
        if (filename === 'jobs.csv') contentId = 'jobsContent';
        else if (filename === 'places.csv') contentId = 'placesContent';
        else contentId = 'proxiesContent';

        const content = document.getElementById(contentId).value;

        fetch(`/api/files/${filename}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: content })
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) showToast(`${filename} saved!`, 'success');
                else showToast('Save failed', 'error');
            });
    }

    // â”€â”€ Job Management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function addSingleJob() {
        const category = document.getElementById('addCategory').value.trim();
        const city = document.getElementById('addCity').value.trim();
        const country = document.getElementById('addCountry').value.trim();

        if (!category || !city || !country) {
            showToast('Fill all fields', 'error');
            return;
        }

        fetch('/api/jobs/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ category, city, country })
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showToast('Job added!', 'success');
                    document.getElementById('addCategory').value = '';
                    document.getElementById('addCity').value = '';
                    document.getElementById('addCountry').value = '';
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast(data.error || 'Failed to add', 'error');
                }
            });
    }

    function bulkImport() {
        if (!confirm('Import all category Ã— city combinations from jobs.csv and places.csv?')) return;

        showToast('Importing jobs...', 'info');

        fetch('/api/jobs/bulk-add', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast(data.error, 'error');
                }
            });
    }

    function deleteJob(jobId) {
        fetch('/api/jobs/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ job_id: jobId })
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    document.querySelector(`tr[data-job-id="${jobId}"]`)?.remove();
                    showToast('Deleted', 'success');
                }
            });
    }

    function deleteSelected() {
        const ids = Array.from(document.querySelectorAll('.job-cb:checked')).map(cb => parseInt(cb.value));
        if (!ids.length) { showToast('No jobs selected', 'error'); return; }
        if (!confirm(`Delete ${ids.length} job(s)?`)) return;

        fetch('/api/jobs/delete-multiple', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ job_ids: ids })
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showToast(`Deleted ${data.deleted} jobs`, 'success');
                    setTimeout(() => location.reload(), 1000);
                }
            });
    }

    function clearCompleted() {
        if (!confirm('Clear completed and failed jobs from history?')) return;
        fetch('/api/jobs/clear-completed', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showToast(`Cleared ${data.deleted} jobs`, 'success');
                    setTimeout(() => location.reload(), 1000);
                }
            });
    }

    // â”€â”€ Selection Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function toggleAll(cb) {
        document.querySelectorAll('.job-cb').forEach(c => c.checked = cb.checked);
    }
    function selectAll() {
        document.querySelectorAll('.job-cb').forEach(c => c.checked = true);
        document.getElementById('selectAllCb').checked = true;
    }
    function deselectAll() {
        document.querySelectorAll('.job-cb').forEach(c => c.checked = false);
        document.getElementById('selectAllCb').checked = false;
    }
</script>
{% endblock %}